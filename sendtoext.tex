\chapter{ほかのメールサーバにメールを転送する}

次は、先程ｓって伊下メールサーバ以外の、ネットワーク接続されたほかのメールサーバにメールを転送してみましょう。実は、前章までの設定で、帰納的には外にメールを出すのに必要な、最低限の設定はできています。ですが、現在のインターネットでは、そのままではメールが届かなかったり、そのままメールを送ってしまうと問題になったりします。

この章では、メールを外に届けるとはどういうことか、それを見ていくことにしましょう。

\section{名前解決と権威DNS}

これから先の話をするときに、最低限のDNSに関する知識が必要となります。メールのサービスはDNSを前提としているので、正しい運用には、DNSの知識も不可欠です。

本書はPostfixの本なので深くは立ち入りませんが、今後の説明に必要になる部分について、DNS二巻する説明をします。

\subsection{名前解決}
インターネットのホストにアクセスするとき、アクセス先を表すのに、通常はwww.uranohoshi.exampleやmail.utx.exampleのように、干すトメイと呼ばれる名前を使用します。192.168.1.1や2001:db8::1/64のような、IPアドレスでもアクセスできますが、人間の負担が大きいので、通常は使用しません。

ですが、実質的にスタンダードであるプロセス間通信の手段であるsocker(2)は、接続先を表現するのに、IPアドレスを必要とします。そのため、socket(2)を利用するソフトウェア側で、何らかの手段でホスト名とIPアドレスをマッピングする手段を用意する必要があります。
何らかの手段で、ホスト名とIPアドレスのマッピングができたとき、それを名前解決ができた、表現します。名前解決の方法には、DNSに情報を問い合わせる、ローカルのマッピングテーブルを参照する、などがあります。

\subsection{権威DNS}
あるインターネットドメインの権威DNSとは、そのドメインについて全てのホスト名の情報を持っていて、外部からそのドメインのホストに関する問い合わせに回答する権限を持つものを指します。

たとえば、uranohoshi.exampleドメインの権威DNSは、FQDNにuranohoshi.exampleというインターネットドメインを持つホストについて、名前解決の問い合わせに応える機能と情報を持っています。\footnote{サブドメインを別のDNSに管理してもらう委譲の概念もありますが、本書では深く立ち入りません。DNS関連の資料を参照してください。}
また、権威DNSは、そのドメインの権威DNSの名前や、メールサーバの名前などの情報も持っています。

\subsection{逆引き解決}
名前解決は、ホスト名と、対応するIPアドレスのマッピングを行うことでした。その逆に、IPアドレスからホスト名の方向のマッピングをすることを、逆引き解決とよびます。

逆引き解決は、多くの場合、それ用のDNSによって提供されます。また、この逆引き用DNSは、ドメインの権威DNSとは、関係ないホストで運用されることも多いです。

\section{ほかのメールサーバを知る}

他のメールサーバの存在は、どのように知れ知れば良いのでしょうか。Postfixをはじめとする｀MTAは、自分自身が管理するメールアドレスが宛先でないメールは、全て他のサーバに転送しようとします。このとき、どこのサーバに転送すれば良いかを知る必要があります。

そのためには、メールサーバは、DNSによる名前解決ができなければなりません。では、メールサーバではどのような情報が得られるのでしょうか。

\subsection{他のメールサーバ接続する}
メールアドレスchika@mail.uranohosi.exampleから、honoka@mail.otonoki.exampleにメールを出そうとしたとします。この場合は、メールボックスが存在するホスト名がメールアドレスとして書かれているので、ホスト名の名前解決ができれば、メールを送ることが可能です。
メールサーバが他のメールサーバに接続するとき、INETドメインで25/TCPのソケットを開かなければ鳴りません。そのため、何らかの手段で、ホスト名とIPアドレスを対応づける方法が必要です。そして、その多くは、DNSで、AレコードもしくはAAAAレコードを参照し、その結果情報を利用して、メールサーバに接続します。

\subsection{他のドメインのメールサーバを知るには}

メールの送信先アドレスとして、honoka@otonoki.exampleと、メールアドレスがドメイン名のみで記載されている場合は、どうやって、otonoki.exampleのメールサーバの名前やIPアドレスを知れば良いのでしょうか。

これも、DNSの情報を参照します。メールサーバがドメインに対してメールを転送するとき、メールサーバはDNSに、そのドメインのMXというレコードの情報を問い合わせます。このMXは、Mail eXchanger、つまり、メールサーバという意味をもったレコード名です。
あるインターネットドメインの権威DNSは、そのドメインのメールサーバの情報を、MXレコードとして回答します。そのMXレコードの例をしめすと、のようになります。

\begin{verbatim}
otonoki.example.  86400  IN  MX 10 mail.otonoki.example
                  96400  IN  MX 20 mail2.otonoki.example
\end{verbatim}

MXレコードの回答を見ると、otonoki.exampleドメインのメールサーバは、mail.otonoki.exampleとmail2.otonoki.exampleの二つあることがわかります。では、このふたつのレコードに記載された数字は何なのでしょうか。

最初の86400は、TTL(Time To Live)と言われるフィールドです。この情報をキャッシュしてもかまわない秒数を表します。この例だと、86400秒、つまり有効時間は1日です。TTLは強制で無く、問い合わせる側に向けた指標です。そのため、TTL時間いっぱい前回の問い合わせをキャッシュして使う、という運用はあまりありありません。

次に現れている、10や20という数字は、メールサーバの優先度です。どのドメインに複数のMXがあるときは、優先度の数字がが小さいものから、メールの転送を試みることになっています。この例では、最初に優先度10のmail.otonoki.exampleにSMTPでの接続を試みます。それが失敗した場合、その次の優先度である、mail2.otonoki.exampleに接続を試みます。

DNSのMXレコードについては、外部からメールを受け取るための設定の説明を行う際に、再度取り上げます。

\section*{}
\begin{itembox}[l]{DNSラウンドロビン}
もし、複数のMXレコードで優先度が同じであったら、どのメールサーバが利用されるのでしょうか。同じ優先度のメールサーバが複数あるときは、そのうちから1台、確率的に選び出します。そのため、同じ優先度のメールサーバが複数あるときは、同じ確率でどれかが選ばれる、というのが正解です。

また、ひとつのホスト名に対して、複数のAレコードや、複数のAAAAレコードを設定することもあります。この場合も、Aレコード、もしくはAAAAレコードのどれかが、確率的に選択されます。

このようなDNS情報の設定の仕方を、DNSラウンドロビンと読んでいます。複数あるレコードのどれかが選ばれる状況を、駒鳥(ロビン)が素に戻るときにぐるぐると同じ所を廻って、素の場所を特定されるのを避けている行動になぞらえたものです。
\end{itembox}


\section{OPB25とS25R}
前章で行った設定と、メールサーバが名前解決が行えるだけの設定をすれば、それでメールサーバに、外部にメールを送る機能が備わったことになります。ですが、現在のインターネットでは、それだけでは、他のメールサーバにメールを転送することができません。それは、OPB25と、S25Rというセキュリティ手法Jのためです。

\subsection{OPB25}
OPB25とは、Outbound Port Blocking 25の略で、外部25番ポートへの接続ブロッキング、という意味になります。OP25や、OP25Bとしている資料もあります。

不正なメール送信を防ぐ目的で、インターネットプロバイダが、そのプロバイダがサービスとして提供しているメールサーバ以外、つまり、そのプロバイダのネットワークの外にあるメールサーバの25/TCPへのアクセスをブロックする、というセキュリティ手法です。この設定がされているインターネットプロバイダを利用している場合、インターネットに接続されたメールサーバの25/TCP二アクセスできません。つまり、SMTPで接続ができません。

O{B25は、インターネット接続を利用する個人ユーザに向けて設定されることが多い制限です。

\subsection{S25R}

メールサーバに接続してきたホストのIPアドレスから逆引きをして、そのIPアドレスに対応するホスト名がメールサーバっぽいかどうかで接続を許可するか拒否するか判断する手法です。S25Rとは、Selective SMTP(25) Restrictionの略で、選択的SMTP制限、という用な意味になります。

インターネットプロバイダを使用する個人ユーザに割り当てられるIPアドレスに対応する名前は、一見して、その用途であると判るような名前を付けられています。
このような名前が付け羅得ているホストからのアクセスは、正規のメールサーバでないとみなして、接続を拒否します。
また、逆引きで得たドメイン名の情報が、送信されたメールの発信元のドメインと一致しなかったり、逆引き解決ができない場合も、同様に接続拒否をします。

\subsection{S25R+クレイリスティング}
セキュリティの都合や、複数ユーザ相乗り型のレンタルサーバであるなどの理由で、逆引きができないホストが多く、S25Rをそのまま使うのは、拒否する必要が無いホストからの接続を拒否してしまう、フォルスポジティブが発生します。

そのフォルスポジティブを減らすために、S25Rを、グレイリスティングのトリガーにするという方法があります。このグレイリスティングは、正規のメールサーバかどうか疑わしいホストからの接続を、初回接続から5分間拒否するという手法です。
メールサーバとして動作しているホストであれば、規約に従って、接続に失敗したホストに、5分以上後に再接続を試みます。そうやってメールを送信してきたホストを、ホワイトリストに入れ,一定期間SMTP接続を認める、という手法です。

その一方、不正なメールを送信しようとするホストは、多くの場合、5分後に再送信をしません。そのため、グレイリスティングによって、ほとんどの不正なホストからのSMTP接続をブロックすることができます。




\section{全てのメールを特定のメールサーバに送る}
メールサーバに届いたメールで、そのメールサーバ自身が宛先でないメール全てを、特定のメールサーバに送ることができます。たとえば、LANの中でインターネットに接続されたメールサーバが1台だけあり、外にメールを出すには、そのサーバに一度メールを転送しなければいけない、というような場合に、この設定を行います。

注意として、この設定で転送先とするサーバの管理者から、全てのメールを転送することを許可されている状態で行ってください。そうでないなら、メールを送りつける攻撃になってしまいます。

全てのメールを転送素には、relayhostディレクティブに、転送先のメールサーバを設定します。デフォルト状態で、\$relayhostは値が設定されていません。

main.cf(5)でコメントアウトされている設定例として、このようなものが挙げられています。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
#relayhost = $mydomain
#relayhost = [gateway.my.domain]
#relayhost = [mailserver.isp.tld]
#relayhost = uucphost
#relayhost = [an.ip.add.ress]
\end{lstlisting}

Postfixでは、メールを転送する先を、角括弧の有無で区別します。それは、DNSでMXレコードを検索するかどうかの違いです。

\subsection{MX検索を行う場合}
\$relayhostの値が角括弧無しのとき、Postfixは、その値を転送先のドメイン名であると見なします。そして、DNSから転送先となるドメインのMXを検索し、MXレコードに記載されたメールサーバの転送を試みます。このとき、DNSでは使用するポートの情報が得られないので、ポート番号は指定できません。必ず、宛先となるメールサーバの、SMTPのウェルノウンポートである｀25/TCPにメールが送られます。

以下のようき記載した場合、utx.exampleのMXを検索し、utx.exampleドメインのメールサーバに全てのメールを転送します。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
relayhost = utx.example
\end{lstlisting}

\subsection{MX検索を行わない場合}
角括弧有りの場合は、MX検索は行いません。角括弧の中に書かれた内容がIPアドレスかホスト名歌を判別します。そして、ホスト名の場合は、名前解決を行います。また、角括弧の後にコロンを付けて、ポート番号を指定することもできます。

以下の設定例では、mail.otonoki.exampleのポート2525に、全てのメールを転送する設定です。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
relayhost = [mail.otonoki.examle]:2525
\end{lstlisting}

\section*{}
\begin{itembox}[l]{ウェルノウンポート}
インターネットプロ取るスイートのアプリケーション層は、トランスポート層のサービスを利用します。この時、アプリケーションを特定し、また、インターネットプロトコル層での経路を多重化して使うために使われているのが、トランスポート層のポート番号です。

このポート番号は、アプリケーションを区別するのにも使います。25/TCPはメールサーバ、80/TCPはWebサーバに対応づけられている、という具合です。この、慣習的にアプリケーション毎に決められた、標準でこのポートを使うべき、というポート番号を、ウェルノウンポート(Well-Known port)といいます。

厳密には、ウェルノウンポートは、、アプリケーション層のプロトコルごとに定められています。たとえば、25/TCPならSMTPに対応しており、また、53/UDPならDNSです。また、インターネットに接続されてサービスをするサーバは、そのサービスのアプリケーションプロ取るに対応したウェルノウンポートを使用するという前提で、ポート番号の指定は省略します。

もちろんウェルノウンポート以外のポート番号で待ち受けることも可能です。この場合、ホスト情報の末尾に、転んで区切ってポート番号を書きます。TCPかUDPかは、アプリケーションもしくはアクセススキーマで決まっているので書く必要は有りません。たとえば、Webアーバwww.utx.exampleの8080/TCPに、アプリケーションプロトコルHTTPでアクセスするときは、以下のようなアクセススキーマを用います。

\begin{verbatim}
http://www.utx.axample:8080/
\end{verbatim}

\end{itembox}

\section{インターネット接続されたメールサーバにメールを送る}

では、インターネット接続されたメールサーバに、宛先の応じてメールを転送するにはどのようにすれば良いでしょうか。それは、OPB25やS25Rの規制を受けない環境でメールサーバを運用することと、他のメールサーバから、SMTP接続を受けて良いサーバとみなされる設定にすることです。

それも踏まえてここでは、どうすれば外にメールを送れるメールサーバが作れるか、それを考えてみましょう。

\subsection{メールサーバをどこに置くのか}
インターネットプロバイダを利用したインターネット接続では、多くの場合、固定IP割り当てサービスを利用していない場合、、
OPB25の対象となっていることが多いです。つまり、外部にメールを転送しようという場合、少なくとも固定IPアドレスの割
り当てを受ける必要があります。

ひとつ方法として、インターネットプロバイダ以外のかｔちでインターネット接続されたサーバを持てばよいということになります。データセンタに自前のメールサーバをハウジングする、メールサーバ用にレンタルサーバを契約する、というやりかたです。これらの方法は、メールサーバという泊められないサービスを止めるリスクを減らすという意味もあります。そのため、メールを出すことも層ですが、この後で説明する、外部からのメールを受信することについても徳治重要です。

一方、インターネットプロバイダから固定のiPアドレスの割り当てを受け、グッローバルのIPアドレスを持つホストを、メールサーバとして運用するというやり方もあります。このようん、インターネットプロバイダの接続サービスでも、グローバルのIPアドレスを固定的に割り当てるものは、多くの場合OPB25の対象となっていません。
この方法は、サーバを常時手元に置けるという利点はありますが、通常のオフィスビルなどでは、点検のための法定停電があり、メールサーバを泊めないという目的にはあまりあわないという欠点もあります。

\subsection{なぜメールサーバにはグローバルのIPアドレスが必要なのか}
ここまで出、グローバルのIPアドレスをメールサーバに割り当てられる場合は、おおおよそOPB25の適用外でアリ、メールを任意に外部のサーバに転送することができると見当が付いたのではないかと思います。
では、そのような制限がされているのは何故でしょうか。

メールは双方向のコミュニケーションとして設計されました。これは、一方から送りつけた者を一方が受け取って処理するクライアント/サーバ型のサービスではなく、双方が対等なPeer to Peer(P2P型サービスであるということです。

もしメールサーバがNATの内側に合ったらどうなるでしょうか。NATの内側から送信されたメールサーバからのメールを受けたサーバは、そのサーバ宛の返信メールがあったとしても、それを送ることができません。NAT八草の構造上、クライアント/サーバ型構成であって、P2Pにはなりえないためです。
つまり、大量のメールを一方的に送りつけ、そのエラーメッセージであるエラーメールは受け取らない、という身勝手なメールサーバが存在できることになっています。
また、メールサーバの名前などの設定で、いくらでも別のドメインのメールサーバを名乗る音が可能です。これはどこに接続されたメールサーバでも同じ事ですが、とくにNATの内側にあるホストは、OPB25によって、外部のホストにSMTP接続をさせないようにしています。

そのため、プロバイダは、一般的なユーザからのメール送信を、自分が運用するメールサーバにメールを集めて代行する一方、外部のメールサーバへは直接接続させないOPB25を設定しています。

\section{メールサーバの信用}

例えグローバルのIPアドレスを持っているホストがSMTP接続してきたとして、メールサーバはその接続元を信用していいのでしょうか。それは、あるドメインについて、正式なメールサーバが何であるかをアナウンスすることです。SMTP接続を受けるサーバは、その情報を参照して、SMTP接続してきたホストからメールを受け取っていいかを判断します。

そこで、メールを発信する側は、自分のドメインのメールサーバの情報を開示します。そして、その情報にないホストは、正規のメールサーバとして扱わなくて湯良いことをアナウンスします。

ただし、この情報はあくまでもメールを送ってきた側のドメイン管理者が自己申告しているものです。ドメインの持ち主や、そのメールサーバが贈ってくるメールの内容を担保するものではありません。

この、SMTPで接続してくるホストが正当なものか、そして、転送されるメールが正当なメールサーバから送信されたものかを判定するための情報は、そのドメインの権威DNSによっ手提供されます。
つまり、現在では、メールサーバがメールを転送するという局免でも、権威DNSとの連携が不可欠であるというｋとです。

\subsection{Sender Polict Flamework}
SPF(Sender Policy Framework)は、ドメインの権威DNSに、メールを送信するホストの情報を記載し、問い合わせに応じて応答します。RFC7208で規格化されています。
それによって、SMTPで接続してきたホストが、そのドメインの正規のメールサーバであるかどうかの判別に使います。

SPFは、MXットは全く別の情報です。MXの問い合わせははメールを送る先のサーバを返すフィールドで、DNSには最初から備わった機能です。その一方、SPFは後からDNSの企画が固まってから、送信元ホストの情報を回答する手段として追加された企画です。そのため、任意情報を記載するためのTXTフィールドを使います。

SPFはPostfixでなく、ドメインの権威DNSで設定します。そのため、その設定方法については、付録に一生設けて説明をします。

\subsection{Domainkeys Identified Mail}
DKIM(Domainkeys Identified Mail)は、メールサーバがメールを転送するときに、そのメールに電子署名を付加します。ｘそれによって、メールの送信者と、本文の改竄が無いことを示します。SPFは接続してきたホストの正当性をしめすものでしたが、DKIMは、そのメールの内容の正当性を示すものであることに注意してください。このDKIMは、RFC6376で規格化されています。

電子署名の正当性をを判定するための公開鍵は、DNSが問い合わせに対して回答します。メールを転送された側は、電子署名が正しければ、そのメールが正当な者として取り扱うことになっています。
Postfixの標準機能にDKIMはなく、外部プロセスの呼び出しが必要となるため、本書ではその説明に留めます。

\subsection{Domain-based Message Authentication, Reporting, and Conformance}
DMARC(Domain-based Message Authentication, Reporting, and Conformance)は、SPFやDKIMで正当でないと判定されたメールの扱いについて、受信側に取り扱いの仕方を依頼する情報です。DMARCもまた、DNSのTXTレコードに記載され、DNS問い合わせによって回答されます。

送信元から送信されたメールの扱いや、DKIMで正当でないと判定されたメールについて、レポーティングなど、どんな扱いをして欲しいかを依頼します。
DMARCに対応してるメールサーバが受信側であれば、不正と判定したメールについて、DMARC情報に従ってレポーティングなどの処理を行います。


\section{メールキュー}

本省の最後に、まだ次の宛先に転送できていないメールの扱いについて記載しておきましょう。外部のサーバにメールを送信するときには、その相手のサーバが停止している、等の理由で、すぐにメールを転送できないことがあります。このように、まだ転送されていないメールは、一時的に、メールキューというバッファに置かれます。

メールキューには、最長で5日間メールが置かれます。ですが、それまでにキューにあるメールを削除したり、強制送信したりしたい場合があります。その操作について、説明を縞方。

\subsection{メールキューの状態を見る}
メールキューの状態を見たいときは、mailq(1)をrootで実行します。mailq(1)はsendmail互換コマンドで、postqueue(1)に、-pオプションをつけて実行しても同じ結果が得られます。

未送信のメールにキューがある場合は、このような結果が表示されています。1行目が項目の説明、2行目が送信メールアドレスと送信時刻などの情報、2行目が宛先です。

\begin{verbatim}
root@mail:~ # mailq
-Queue ID-  --Size-- ----Arrival Time---- -Sender/Recipient-------
7C7147843*      322 Wed Jul 25 18:13:23  chika@uranohoshi.example
                                         honoka@otonoki.example


-- 0 Kbytes in 1 Request.
\end{verbatim}

一度メール転送を試みて、失敗してメールキューに留まっているメールについては、理由が記載されます。
以下の例では、otonoki.exampleのメールサーバが応答せずタイムアウトになり、メールがキューに置かれています。

\begin{verbatim}
root@mail:~ # mailq
-Queue ID-  --Size-- ----Arrival Time---- -Sender/Recipient-------
7C7147843*      322 Wed Jul 25 18:13:23  chika@uranohoshi.example
   (connect to mail.otonoki.example[xxx.xxx.xxx.xxx]:25: 
                                    Operation timed out)
                                         honoka@otonoki.example


-- 0 Kbytes in 1 Request.
\end{verbatim}

\subsection{メールキューの操作}

メールキューに対する主要な操作は、強制的に再送信を試みるフラッシュと、メールの削除です。sendmail互換コマンドの関係で、Postfixにはいくつか操作の方法があります。ここでは、Postfixのコマンドで操作する方法を説明します。

\paragraph{メールキューにたまったメールの強制排出}
Postfixでメールキューにたまったメールの強制送信を試みるときは、postqueue(1)に、-fオプションを着けて実行します。この操作は、実行次点でメールキューにあるメール全てについて、再送信を試みます。特定のメールひとつだけを再送信する、という操作はできません。

\begin{verbatim}
root@mail:~ # postqueue -f
\end{verbatim}


\paragraph{メールキューにたまったメールの削除}
メールキューにあるメールを削除したい場合は、postsuper(1)を使用します。キューにある特定のメールを削除したい場合は、-dオプションの後に、mailq（1）コマンドで表示されたQueue IDを書いて実行します。
このQueue IDは、maillognにも記載されていルので、そちらで確認することもできます。


さきほどの例で、chika@uranohoshi.exampleからhonoka@otonoki.example宛に送信されたものの、キューに貯留されていたメールを削除すると、以下のようになります。

\begin{verbatim}
root@mail:~ # postsuper -d 7C7147843
postsuper: 7C7147843: removed
postsuper: Deleted: 1 message
\end{verbatim}

この操作は、メールログにも記録が残ります。

\begin{verbatim}
Jul 25 18:41:10 festa postfix/postsuper[28735]: 7C7147843: removed
Jul 25 18:41:10 festa postfix/postsuper[28735]: Deleted: 1 message
\end{verbatim}

メールキューにある全てのメールを削除するときは、Queie IDのかわりに、ALLと書いてコマンドを実行してください。

\begin{verbatim}
root@mail:~ # postsuper -d ALL
\end{verbatim}