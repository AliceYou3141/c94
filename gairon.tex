\chapter{メールサーバの概論}

まず、電子メールはどのように遣り取りをされて、送信した側からメールサーバを経由して相手の手元に届いているのでしょうか。その流れについて、簡単に説明していきましょう。

\section{メールをやり取りするしくみ}

そもそも、電子メールはどのように遣り取りされているのでしょうか。メールを送信すると、早ければすぐに、遅くても数分後には、宛先担った側でそのメールを見ることができる状態になります。
その間には、どのような遣り取りが介在して、最終的にどのようにメールが届いているのでしょうか。

\subsection{メールが届くまでの流れ}

メール送信されてから届くまでの流れとして、出したメールが宛先に届くまでを見てみましょう。

メールソフトでメールを作成すると、そのメールは、まずメールサーバに送られます。このメールサーバは、メールのソフトに設定がされている特定の宛先で、このクライアントから送信される全てのメールは、このメールサーバに送られます。
そのメールを受け取ったメールサーバは、宛先を見て、宛先が自分が管理しているメールアドレスであれば、メールを保存します。
自分が管理しているメールアドレスでないときは、設定やDNSから転送する先のメールサーバを探して、転送します。

この転送を繰り返して、メールは最終的に、宛先のメールアドレスを管理しているメールサーバに到着します。
到着したメールを保存するサーバを、メールボックスサーバと呼ぶことがあります。

メールを受信する側は、定期的にメールボックスサーバにアクセスします。このとき、メールの転送とは別のサービスで、メールボックスのデータをダウンロード、もしくは参照します。
このような流れで、送信したメールを、宛先で参照できるようになるわけです。

\section{メール送信から宛先到着まで}

では、メールを作成して、そのメールがどのように相手に届くか、もう少し詳しく見てみることにしましょう。おおまかにわけると、メールを作成したクライアントがインターネットプロバイダなどのメールサーバにメールを転送する過程、インターネット接続されたメールサーバの間でメールが転送される過程、最終的な宛先となるサーバに置かれたメールを、宛先のクライアントが参照するための過程の3つになります。

\subsection{メールクライアントとメールサーバのやりとり}

メールを送信するときは、どのような流れだったでしょうか。
メールクライアントとなるソフトが、メールサーバに接続します。そして、クライアントはサーバに送信するメールの宛先情報と、本文データをわたします。クライアント側から見たメールの送信は、これだけです。

ここで言うクライアントとは、PCやスマートフォンなど、ユーザがメールを送信したり、メールを読んだりする端末を指します。また、メールサーバはプロバイダなどが用意するメールサーバで、クライアントから送信される全てのメールを転送する先となります。
このようにクライアントからメールを集めるサーバを、メールを集めるという意味で、メールハブと呼ぶことがあります。
メールハブのハブは、スイッチングハブやハブ空港と同じ意味のハブです。


メールサーバが受け取ったメールがその後どのように扱われるかは、クライアントが制御することはできません。これはいわば、郵便のポストに郵便を投函するメタファーで考えることができます。クライアントは、郵便ポストにメールを投函することができますが、そこから先は制御することができません。

この部分の、クライアントからサーバの一方通行です。なぜなら、現在のネットワークでは、クライアント側がグローバルのIPアドレスを持っていないことが多いので、いわゆるクライアント/サーバ型の校正になります。


\subsection{メールサーバとメールサーバのあいだの遣り取り}

では、メールを受け取ったメールサーバはどのように動作するのでしょうか。
メールサーバは、受け取ったメールを、ここから説明する処理を待つために置いておくためのストレージに保存します。この領域を、メールスプールとよびます。

次に、メールサーバは、届いたメールの宛先をチェックします。そして、その宛先が自分、つまりメールを受け取ったサーバであれば、ストレージにメールを保存します。この、メールを保存する領域を、メールボックス(郵便受け・私書箱)という呼び方をしています。これも、郵便のメールのメタファーです。

宛先のメールアドレスをチェックして、自分宛でない、もしくは特定の転送先が設定されている、という判定結果が出た場合は、そのメールを、別のメールサーバに転送します。
どのメールサーバに転送するかは、設定がしてあればその設定情報に従います。その設定情報が無い場合は、宛先のドメインのメールサーバの名前をDNSで検索して、そのメールサーバに転送します。

別のサーバにメールの宛先とデータを転送したら、メールサーバは手元にあるデータを消します。これは、自分が管理しているメールボックス宛ではないないメールであるためです。

メールサーバとメールサーバとのあいだの通信は、基本的にP2P型です。メールを転送する側がクライアントとして、メールを受け取る側がサーバとして動作します。メールサーバは、状況に応じてサーバとクライアントとのそれぞれの動作をします。
メールは、メールサーバの間をバケツリレーのように転送され、最終的に収めるべきメールボックスを持ったメールサーバに辿り着きます。
この、メールが転送されるときの経路をどのように設定するかを、メールルーティングとよびます。

つまり、メールを他のメールサーバに送って宛先であればメールボックスに保存してもらう、という過程において、クライアントとメールサーバ、メールサーバとメールサーバのそれぞれで、同じ処理をしていることがわかります。
このように、メールをクライアントになった側からサーバになった側に転送するためのアプリケーションプロトコルを、SMTP(Simple Mail Transport Protocol)とよんでいます。
また、SMTPでメールを遣り取りするサービスを、MTA(Mail Transport Agent)と呼ぶことがあります。


\subsection{サーバに届いたメールをクライアントが受け取るやりとり}

では、メールサーバのメールボックスに届いたメールを、宛先のユーザが参照するには、どのようにするのでしょうか。

メールボックスに届いたメールを、メールサーバ以外から参照するときに使われるサービスが、POP(Post Office Protocol)と、IMAP(Internet Message Access Protocol)の二つのプロトコルです。これはどちらも、サーバにあるメールボックスのメールを参照するものですが、その方法が異なり、どちらも用途に応じて使用されています。

POPやIMAPは、元々のメールサーバには実装されていない機能でした。そのような歴史的経緯から、別サービスとして構成され、必要に応じてサービスを提供します。
そして、POPやIMAPのサービスを、MTAに対して、MRA(Mail Retrival Agent)と呼ぶことがあります。

POPは、メールボックスにあるメールをまとめてクライアントにダウンロードします。そのため、ダウンロードしたメールは、ネットワークへの接続の有無にかかわらずクライアントで参照することができます。
そのかわり、POPは、メールボックスにあるメールの件名を取得する、ダウンロードする、削除する、という簡単な操作しかできません。このことで、サーバとの接続を維持する時間が短く、間欠的な接続で構わないという利点があります。

IMAPは、メールボックスにあるメールをブラウズする、というイメージです。動作としては、WebのHTTPのように、その場で参照して、参照がおわったクライアント側のキャッシュの寿命は保証されません。
再度参照が必要になった場合は、改めてサーバに見にいくことになります。

このように、IMAPはメールのデータをサーバに置いたままにします。そのため、メールボックスのあるサーバに多くのストレージを必要とする、IMAPのサーバとクライアントは、コネクションを維持しておく必要があります。つまり、サーバとネットワークにPOPより多くのリソースを必要とします。そのため、初期のインターネットでは、リソースを専有できるプライベートなメールサーバ以外では、IMAPサービスは提供されることはありませんでした。

ですが、現在はサーバやネットワークのリソースが十分に供給できるので、インターネットプロバイダのメールでもIMAPが利用可能です。IMAPの利点として、サーバ側でフォルダを作ってメールの整理をすることができることが挙げられます。
そして、全てのメールがサーバ側にあるため、種類の違う複数のクライアントで見ても、同じメールデータを参照することができるという、大きな利点があります。

\section*{}
\begin{itembox}[l]{Webメールってどんなもの}

メールサーバのメールボックスに届いたメールを参照するには、Webメールという、Webアプリケーションを使用することもできます。
代表的なWebメールとしてはGmailやYahooメールなどがあります。また、多くのIMAPを提供しているインターネットプロバイダでは、Webメールによるメールの参照サービスも提供しています。

Webメールとは、IMAPのクライアントとして実装されているWebアプリケーションです。IMAPでメールボックスを持つサーバと通信して、メールボックスのデータをWebブラウザからユーザが参照、操作できるようにしています。
IMAPサーバとの通信はIAMPを使用するので、IMAPサーバとWebメールのアプリケーションは、自由に組み合わせることができます。

\end{itembox}

\section{MTAとMRAはなぜ別々の実装なのか}

では、SMTPサーバとPOP/IMAPサーバはなぜ、別の実装なのでしょうか。それは、メールという仕組みの歴史的な経緯があります。

もともと、電子メールの遣り取りは、SMTPで行われていました。このSMTPは、TCP/IPよりも古いプロトコルで、初期のRFCには、複数種類のトランスポート層プロトコルへの対応が記載されていました。

その頃は、インターネットに繋がれている全てのホストは、グローバルのIPアドレスを持っていました。これは、個人が専有して使用していたワークステーションでもそうです。そのため、当時は、インターネットに接続された全てのホストは、他のホストに直接メールを送ることができました。
これがどういうことかというと、ユーザが使用していたホストに直接、SMTPでメールが届いていたということです。初期のメールは、完全なP2Pのサービスでした。
そして、当時、ローカルのストレージに置かれたメールを、ユーザは各種コマンドを使って直接読んでいました。
semdmailやPostfixには、ローカルなメールボックスに置かれたメールを直接読むコマンドとして、mail(1)が付属しています。


POPやIMAPというプロトコルが必要になったのは、メールサーバに届いたメールを、クライアントが参照しに行く、という、メールサーバとメールクライアントを、明確に分けたいという要望に対応したことでした。1984年に提出された、POPの最初のRFCであるRFC918\footnote{https://tools.ietf.org/html/rfc918}で、SMTPでメールを遣り取りして届いたメールを保存するメールスプールサーバとにワークステーションがアクセスするためのプロトコル、として考案されたという記載があります。



もちろん、現在では、SMTPサーバとPOP/IMAPサーバをまとめてパッケージにしたものも存在します。商用で有名な統合パッケージには、マイクロソフトのExchangeサーバが挙げられます。
Exchangeサーバは、メールの送受信に必要な機能をモノリシックに実装した製品です。

一方のOSSではどのおうなものがあるでしょうか。これは、MTAとMRA,そして、それらが使う認証系をひとまとめにしたパッケージです。
ひとつ紹介をすると、Courier Mail Suiteというパッケージがあります。
もっとも、このCourier Mail Suiteは、全体で使われることよりも、POP/IMAPのサービス部分を独立したパッケージ化したCourier-IMAPとして使われることが多いです。

\section{メールというデータ}
実際にメールサーバで遣り取りされるメールとは、どのようなデータなのでしょうか。
メールは、TCPで転送される、テキストのストリームです。つまり、送信されるデータはテキストであり、受信するデータもテキストです。

その構造は、おおきくヘッダと本文に分けることができます。テキストの先頭部分に、送信元や宛先、件名といった情報から、途中のメールサーバがチェックの結果を記載した情報まで、そのメールに関する情報が記載されます。


\subsection{メールの構造}
では、実際のメールの構造を見てみることにしましょう。最低限のヘッダ情報と、本文のみのメールは、以下のような構造をしているテキストです。

\begin{verbatim}
To: mari@mail.uranohoshi.example
Subject: test
Date: Sun, 22 Jul 2018 19:37:28 +0900 (JST)
From: User Kanan <kanan@mail.uranohoshi.example>

test mail
.
\end{verbatim}

行の先頭がアルファベット大文字で始まり、コロンで区切られている行がヘッダです。ヘッダ情報として、送信メールアドレス、宛先、件名、送信日時が書かれています。
ヘッダから一行空行を置いて、メールの本文が始まります。このメールの場合は、test mailという一行だけです。本文の最後は、ピリオドひとつだけが書かれた行になります。このピリオドだけの行で、このメールが終了します。




\subsection{添付ファイルとマルチバイト}
ヘッダの後に、メールの本文部分が置かれます。のほ本文部分もテキストです。ただし、元々のSMTPでは、7bit-ASCII、つまり、7bitのみで表現できるASCIIコードのみを扱う使用でした。

そのため、添付ファイルは、メールサーバに渡す前に、Base64というバイナリをASCIIのテキストファイルにエンコードする方法で、ASCIIコードのみに変換してから送信します。こうすることで、SMTPそのものの実装を変更せずに、添付ファイルを遣り取りできます。

また、日本語のルチバイトテキストは、ISO-2011-JPという、7bitのマルチバイトで表現できるようにつくられた文字コードを使用します。現在ではUTF-8を扱えるメール実装も増えていて、多くの場合、UTF-8テキストを送信してもそのまま取り扱うことが可能です。ですが、全てのメールサーバがUTF-8をそのまま扱えるわけではないので、文字化けのやメール不着の原因となることがあります。

\section*{}
\begin{itembox}[]{エンベローブ情報}

メールのヘッダ部分は、メールデータに付加される、メールそのものに関する情報です。つまり、メールのメタデータであると言うこともできます。そして、メタデータに相当する者として、エンベローブ(封筒)情報というものがあります。
では、エンベローブ情報とは、どんな情報なのでしょうか。

エンベローブ情報は、SMTPでサーバとクライアントが通信するときに、遣り取りされる情報です。そして、メールは、エンベローブ情報に従って取り扱われます。

本書では詳細に立ち入りませんが、実際にメールを転送するときは、以下のように、サーバとクライアントのあいだでメッセージが交換されます。ここで、クライアントから送信される、MAIL FROM:に続く送信元メールアドレス、RCPT TO:に続く宛先メールアドレスなどが、エンベローブ情報と呼ばれるものになります。

\begin{verbatim}
220 mail.uranohoshi.example ESMTP Postfix
EHLO little-daemon.uranohoshi.example
250-mail.uranohoshi.example
250-PIPELINING
250-SIZE 10240000
250 SMTPUTF8
MAIL FROM: yohane@mail.uranohoshi.example
250 2.1.0 Ok
RCPT TO: lily@mail.uranohoshi.example
250 2.1.5 Ok
DATA
354 End data with <CR><LF>.<CR><LF>
test mail

.
250 2.0.0 Ok: queued as 4F5637D60
quit
221 2.0.0 Bye
\end{verbatim}


そして、あくまでも自己申告の情報でもあります。つまり、はがきに自分の住所などを書くのと同じようなもの、ということです。

\end{itembox}


\section{メールシステムを作るために必要なこと}

ここまでの説明で、メールシステムとしてメールを遣り取りするためには、MTAとMRAのそれぞれが必要である子とが判りました。本書では、MTAとについて説明します。そのMTAとして、OSSのMTA実装である、Postfixについて、説明していきます。

最初に、MTAとしてのPostfixについて説明します。メールサーバと同じホストの上から、同じホストで管理するメールアドレスに向けてメールを送信できるようにします。

次に、そのメールサーバから、外に向けてメールを出せるようにしましょう。この段階では、メールサーバがクライアントとして動作して、他のメールサーバに接続して、メールを転送できるようにします。


その次で、MTAとして他のメールサーバからメールを受け取れｔる設定を追加します。このときに、メールボックスサーバとしてどのように運用するかを考えましょう。

その次の段階として、プロバイダのメールサーバのように、ネットワーク経由で他のクライアントからメールを受け取り、他のメールサーバに転送できるようにします。このとき、ユーザアカウントのデータベースについても説明します。

