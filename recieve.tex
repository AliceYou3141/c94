\chapter{他のサーバからのメールを受信する}

\section{メール転送を受けるための設定}

他のサーバからメールを転送してもらうというのは、メールサーバSMTPのサーバとして動作するということです。メールサーバの基本は、自分の管理するメールボックス宛のメールは受信し、そうでないなら適切なメールサーバに転送する、というものです。

ですが、外部から受け取ったメールが自分の管理するメールボックス宛でなかったからと言って、それをまた転送していては、それは迷惑メールを送信するのに使われてしまします。そのため、他のメールサーバからノメールを受け馬絵に、設定を見直しておきましょう。

\subsection{どこ宛のメールを中継するのかを決める}
このメールサーバは、どこ宛のメールを受け取るのでしょうか。その設定を行うmain.cf(5)のディレクティブとして、relay\_domainsを説明していました。このディレクティブは、性格医は、どこのドメイン宛のメールを中継するか、とうディレクティブです。

ここで言う中継とは、他のサーバに渡す、という意味だけで無く、このメールサーバのメールボックスへメールを入れるプロセスへの中継、という意味も含んでいます。そのため、もう一度relay\_domainsの設定値をチェックしておきましょう。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
relay_comains = $mydestination
\end{lstlisting}

この設定例のように、\$relay\_domainsの値として\$mydestinationを使用している場合は、そちらも見直しておきましょう。もし、このメールサーバをドメイン宛のメールを受け取るメールサーバにするなら、\$mydestinationに\$mydomainを含むように、以下のように設定します。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
# ドメインのメールｓ-バニするなら2行目か状況によっては
# 一番下の例を有効にする
#mydestination = $myhostname, localhost.$mydomain, localhost
mydestination = $myhostname, localhost.$mydomain,
                localhost, $mydomain
#mydestination = $myhostname, localhost.$mydomain, 
#                localhost, $mydomain,
#                mail.$mydomain, www.$mydomain, ftp.$mydomain
\end{lstlisting}

\$mydomainと、\$myhostnameの値が正しく設定されているかも、あらためて確認しておきましょう。

\subsection{自分が宛先ではないメールは受け取らない設定}
もうひとつ、自分宛のメールを受け取らないための設定項目があります。それは、SMTP接続を待ち受けてメールを受け取るプロセスに、定められた宛先以外のメールを受け取らない、という設定をすることです。

一見すると、この設定があれば全て問題が片付くような気がします。ですが、自分が宛先出ないメールを受け取らないということは、この前の章で試してきた、正規のユーザがメールを出せなくなる、と言うことでもあります。
そこで、他のメールサーバからノメールで、自分宛でない者を拒否しつつ、ローカルからmail(1)でメールが出せる設定がしたい、ということになりました。このように、受信するメールの条件を設定して、一致しない場合は受信を拒否するのが、smtpd\_recipient\_restrictionsというディレクティブです。

\begin{lstlisting}[basicstyle=\ttfamily\footnotesize, frame=single]
# ローカルから送信したメールと自分宛のメールは受け取る
smtpd_recipient_restrictions　= permit_mynetworks ,
                               reject_unauth_destination
\end{lstlisting}

ここで、二つのあたらしいキーワード、permit\_mynetworksと、reject\_unauth\_destinationがでてきました。これらは、Postfixで規定された設定パラメータです。
Postfixの設定パラメータは、ディレクティブの引数となるときでも、\$はつけません。

判定条件を設定するディレクティブでは、その判定条件はファーストマッチです。この例では、最初にpermit\_mynetworksの条件と一致するか、判定します。この判定に成功下メールは、その次のreject\_unauth\_destinationの判定は行わず、受信します。
permit\_mynetworksに一致しなかった場合は、reject\_unauth\_destinationの条件判定が行われます。ここで、reject\_unauth\_destinationに設定された、メール受信の条件に一致したメールは受信されます。もし、どちらの条件にも一致しなかった場合は、その先の判定がないので、そのメールは受信されません。

では、これらの設定パラメータはどのような意味があるのでしょうか。

\paragraph{permit\_mynetworks}
permit\_mynetworksは、\$mynetworksで設定されたネットワークからの接続であれば、メールを受信する、という条件です。もしローカルからメールを出す必要があるときは、入れておく必要がある設定パラメータとなります。
当然、この設定パラメータを使用するときは、\$mynetworksの設定値も確認してください。

\paragraph{reject\_unauth\_destination}
許可されるべき宛先以外のメールは受け取らない、という設定パラメータです。このパラメータが設定されたとき、本書の範囲では、いかのような判定が行われます。

\begin{itemize}
  \item 受け取ったメールの宛先が\$relay])domainsもしくはそのサブドメインと一致している
  \item 最終的な配送先のトキ、\$mydestinationか\$inet\_interfacesと一致する
\end{itemize}

\section*{}
\begin{itembox}[l]{サードパーティーリレー}
自分が宛先出ないメールを受け取ったメールサーバが、無条件にそのメールを、本来の宛先のメールサーバに転送することを、サードパーティーリレー(第三者転送)と言います。では、なぜSMTPはこのような仕組みを未だに抱えているのでしょうか。

初期のインターネット接続線は、常時接続がされていなかったり、されていたとしても回線のリソースが少なかったり、というように、今と比べるとものすごく貧弱でした。そんな中でメールを使っていくために、とりあえず近いサーバに送る、それを受け取ったサーバは、撚り近いところに転送する、というバケツリレー方式でメールを遣り取りしていたわけです。
サードパーティーリレーの機能は、そのために存在していました。

これは、インターネットのユーザがほぼ特定可能だった時代だからできた仕様ですし、世界中どこからでも、直接、宛先となるメールサーバにアクセスできる回線リソースのある現在では、もはや必要が無い機能と言えるかもしれません。

それでも、サードパーティーリレーの機能は、SMTPの中に残っています・

\end{itembox}


\section{ドメインのメールサーバをどう知らせるか}
メールの送信の説明で、送信先のドメインのメールサーバがどこか調べるには、そのドメインの権威DNSにある、MXレコードの情報を取得する、と説明しました。
では、自分がガ他のメールサーバからメールを受信するようになった時、どのサーバがドメインのメールサーバであるかを、どうやって知らせるのでしょうか。

それには、ドメインの権威DNSのMXフィールドを使います。ここでは、メールの転送を受けるメールサーバとう立場で、MXレコードを見直してみましょう。



\subsection{MXレコード}


\section{プライマリとセカンダリ}

\section{不正なメールサーバからの接続拒否}